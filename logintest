// Zabbix 7.0 Browser Synthetic Monitoring
// Purpose: Check Zabbix login page and find Username field

var browser, result;
var browser = new Browser(Browser.chromeOptions());

try {
    var params = JSON.parse(value); 
    // Expected JSON: {"webURL":"http://your-zabbix-server/zabbix/","username":"Admin","password":"zabbix"}
    var url = params.webURL;

    browser.setScreenSize(1366, 768);

    // Step 1 — Open Zabbix login page
    browser.navigate(url);

    // Step 2 — Wait for username field to load
    browser.awaitElement('input[name="name"]', 10000);

    // Step 3 — Find the username and password fields
    var usernameField = browser.findElement('input[name="name"]');
    var passwordField = browser.findElement('input[name="password"]');

    // Optional: Check if both fields exist
    if (usernameField && passwordField) {
        // Fill login info (optional)
        usernameField.setValue(params.username);
        passwordField.setValue(params.password);

        // Click the Login button (CSS selector for Zabbix 7.0)
        var loginButton = browser.findElement('button[type="submit"]');
        loginButton.click();

        // Step 4 — Wait until dashboard or 'Monitoring' appears
        browser.awaitText('Monitoring', 10000);

        result = browser.getResult();
        result.status = 'OK';
        result.message = 'Zabbix login successful';
    } else {
        result = browser.getResult();
        result.status = 'FAIL';
        result.message = 'Username or password field not found';
    }

    result.screenshot = browser.getScreenshot();
}
catch (err) {
    if (!(err instanceof BrowserError)) {
        browser.setError(err.message);
    }
    result = browser.getResult();
    result.status = 'FAIL';
    result.message = 'Error: ' + err.message;
    result.error = { message: err.message };
    result.error.screenshot = browser.getScreenshot();
}
finally {
    return JSON.stringify(result);
}
